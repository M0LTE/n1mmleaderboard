@page
@model IndexModel
@{
    ViewData["Title"] = "Leaderboard";
}

<div class="row">
    <div class="col-md-12">
        <span id="lastUpdate" style="color:yellow; font-size:20pt; font-weight:bold;"></span>
        <table id="leaderboard" class="table embiggen">
            <thead>
                <tr>
                    <th scope="col" style="font-size:50%;">Op</th>
                    <th scope="col" id="measureTitle" style="font-size:50%;"></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <a href="javascript:;" id="byTotalQso">By total QSOs</a> |
        <a href="javascript:;" id="byMult1">By mult 1</a> |
        <a href="javascript:;" id="rateShort">Live QSO rate (short)</a> |
        <a href="javascript:;" id="rateLong">Live QSO rate (long)</a> |
        <a href="javascript:;" id="ratePeak">Peak 5 min QSO count</a>
    </div>
</div>

<script type="text/javascript">
    var totalqsosTitle = "QSOs";
    var mult1Title = "Unique state-bands (mults)";
    var qsoRateShortTitle = "Last 5 min QSO rate";
    var qsoRateLongTitle = "Last hour QSO rate";
    var qsoRatePeakTitle = "Peak 5 min QSO count";

    var measure;
    var lastUpdate;
    var intervalID;
    var requestingNow = false;
    var suffix = "";

    $(document).ready(function () {
        function refreshTable() {
            if (lastUpdate) {
                var msSince = Date.now() - lastUpdate;
                if (measure != "qsopeak" && msSince > 10000) {
                    var warn = "No update for " + msSince + "ms";
                    console.log(warn);
                    $("#lastUpdate").html(warn);
                } else {
                    $("#lastUpdate").html("");
                }
            }

            if (!requestingNow) {
                requestingNow = true;
                $.getJSON("api/leaderboard/" + measure, function (data) {
                    var node = $("#leaderboard > tbody");
                    node.find("tr").remove();
                    jQuery.each(data, function (i, val) {
                        var node = $("#leaderboard > tbody");

                        var h = "<tr><td>" + val.operator + "</td><td>" + val.count + " " + suffix + "</td></tr>";

                        node.append(h);
                    });
                    lastUpdate = Date.now();
                }).always(function () {
                    requestingNow = false;
                });
            }
        }

        // initial view
        measure = "TotalQsos";
        $('#measureTitle').html(totalqsosTitle);

        intervalID = setInterval(refreshTable, 1000);
        refreshTable();
        
        $('#byTotalQso').on('click', function () { 
            measure = "TotalQsos";
            suffix = "";
            $('#measureTitle').html(totalqsosTitle);
            refreshTable();
        });

        $('#byMult1').on('click', function () {
            measure = "TotalIsMult1Contacts";
            suffix = "";
            $('#measureTitle').html(mult1Title);
            refreshTable();
        });

        $('#rateShort').on('click', function () {
            measure = "qsorate/5";
            suffix = "/hr";
            $('#measureTitle').html(qsoRateShortTitle);
            refreshTable();
        });

        $('#rateLong').on('click', function () {
            measure = "qsorate/60";
            suffix = "/hr";
            $('#measureTitle').html(qsoRateLongTitle);
            refreshTable();
        });

        $('#ratePeak').on('click', function () {
            measure = "qsopeak";
            suffix = "";
            $('#measureTitle').html(qsoRatePeakTitle);
            var node = $("#leaderboard > tbody");
            node.find("tr").remove();
            refreshTable();
        });

        /*number of qsos per op
            number of qsos per band per op
            number of ismultiplier1 per op

            gridsquares per op
            states per op*/
    });
</script>